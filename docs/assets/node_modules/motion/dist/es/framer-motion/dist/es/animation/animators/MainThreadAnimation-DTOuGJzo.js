import{millisecondsToSeconds as g,secondsToMilliseconds as _}from"../../../../../motion-utils/dist/es/time-conversion-Dn12LHp6.js";import{calcGeneratorDuration as G}from"../../../../../motion-dom/dist/es/animation/generators/utils/calc-duration-YqvJ4sh_.js";import{isGenerator as w}from"../../../../../motion-dom/dist/es/animation/generators/utils/is-generator--ETSp9aW.js";import{KeyframeResolver as I}from"../../render/utils/KeyframesResolver-DKGlpZg4.js";import{clamp as A}from"../../utils/clamp-CAH81aju.js";import{mix as O}from"../../utils/mix/index-Dtm-V5zR.js";import{pipe as B}from"../../utils/pipe-BH889Yl6.js";import{inertia as x}from"../generators/inertia-C_FPPqb3.js";import{keyframes as v}from"../generators/keyframes-s--laRNp.js";import{spring as C}from"../generators/spring/index-BX2updCw.js";import{BaseAnimation as j}from"./BaseAnimation-vzgFMVGO.js";import{frameloopDriver as U}from"./drivers/driver-frameloop-D8m405jt.js";import{getFinalKeyframe as V}from"./waapi/utils/get-final-keyframe-BIaNfY89.js";const W={decay:x,inertia:x,tween:v,keyframes:v,spring:C},q=P=>P/100;class se extends j{constructor(e){super(e),this.holdTime=null,this.cancelTime=null,this.currentTime=0,this.playbackSpeed=1,this.pendingPlayState="running",this.startTime=null,this.state="idle",this.stop=()=>{if(this.resolver.cancel(),this.isStopped=!0,this.state==="idle")return;this.teardown();const{onStop:n}=this.options;n&&n()};const{name:i,motionValue:r,element:t,keyframes:o}=this.options,u=(t==null?void 0:t.KeyframeResolver)||I,a=(n,l)=>this.onKeyframesResolved(n,l);this.resolver=new u(o,a,i,r,t),this.resolver.scheduleResolve()}flatten(){super.flatten(),this._resolved&&Object.assign(this._resolved,this.initPlayback(this._resolved.keyframes))}initPlayback(e){const{type:i="keyframes",repeat:r=0,repeatDelay:t=0,repeatType:o,velocity:u=0}=this.options,a=w(i)?i:W[i]||v;let n,l;a!==v&&typeof e[0]!="number"&&(n=B(q,O(e[0],e[1])),e=[0,100]);const s=a({...this.options,keyframes:e});o==="mirror"&&(l=a({...this.options,keyframes:[...e].reverse(),velocity:-u})),s.calculatedDuration===null&&(s.calculatedDuration=G(s));const{calculatedDuration:d}=s,p=d+t,f=p*(r+1)-t;return{generator:s,mirroredGenerator:l,mapPercentToKeyframes:n,calculatedDuration:d,resolvedDuration:p,totalDuration:f}}onPostResolved(){const{autoplay:e=!0}=this.options;this.play(),this.pendingPlayState==="paused"||!e?this.pause():this.state=this.pendingPlayState}tick(e,i=!1){const{resolved:r}=this;if(!r){const{keyframes:c}=this.options;return{done:!0,value:c[c.length-1]}}const{finalKeyframe:t,generator:o,mirroredGenerator:u,mapPercentToKeyframes:a,keyframes:n,calculatedDuration:l,totalDuration:s,resolvedDuration:d}=r;if(this.startTime===null)return o.next(0);const{delay:p,repeat:f,repeatType:D,repeatDelay:k,onUpdate:S}=this.options;this.speed>0?this.startTime=Math.min(this.startTime,e):this.speed<0&&(this.startTime=Math.min(e-s/this.speed,this.startTime)),i?this.currentTime=e:this.holdTime!==null?this.currentTime=this.holdTime:this.currentTime=Math.round(e-this.startTime)*this.speed;const y=this.currentTime-p*(this.speed>=0?1:-1),M=this.speed>=0?y<0:y>s;this.currentTime=Math.max(y,0),this.state==="finished"&&this.holdTime===null&&(this.currentTime=s);let b=this.currentTime,K=o;if(f){const c=Math.min(this.currentTime,s)/d;let T=Math.floor(c),h=c%1;!h&&c>=1&&(h=1),h===1&&T--,T=Math.min(T,f+1),!!(T%2)&&(D==="reverse"?(h=1-h,k&&(h-=k/d)):D==="mirror"&&(K=u)),b=A(0,1,h)*d}const m=M?{done:!1,value:n[0]}:K.next(b);a&&(m.value=a(m.value));let{done:F}=m;!M&&l!==null&&(F=this.speed>=0?this.currentTime>=s:this.currentTime<=0);const R=this.holdTime===null&&(this.state==="finished"||this.state==="running"&&F);return R&&t!==void 0&&(m.value=V(n,this.options,t)),S&&S(m.value),R&&this.finish(),m}get duration(){const{resolved:e}=this;return e?g(e.calculatedDuration):0}get time(){return g(this.currentTime)}set time(e){e=_(e),this.currentTime=e,this.holdTime!==null||this.speed===0?this.holdTime=e:this.driver&&(this.startTime=this.driver.now()-e/this.speed)}get speed(){return this.playbackSpeed}set speed(e){const i=this.playbackSpeed!==e;this.playbackSpeed=e,i&&(this.time=g(this.currentTime))}play(){if(this.resolver.isScheduled||this.resolver.resume(),!this._resolved){this.pendingPlayState="running";return}if(this.isStopped)return;const{driver:e=U,onPlay:i,startTime:r}=this.options;this.driver||(this.driver=e(o=>this.tick(o))),i&&i();const t=this.driver.now();this.holdTime!==null?this.startTime=t-this.holdTime:this.startTime?this.state==="finished"&&(this.startTime=t):this.startTime=r??this.calcStartTime(),this.state==="finished"&&this.updateFinishedPromise(),this.cancelTime=this.startTime,this.holdTime=null,this.state="running",this.driver.start()}pause(){var e;if(!this._resolved){this.pendingPlayState="paused";return}this.state="paused",this.holdTime=(e=this.currentTime)!==null&&e!==void 0?e:0}complete(){this.state!=="running"&&this.play(),this.pendingPlayState=this.state="finished",this.holdTime=null}finish(){this.teardown(),this.state="finished";const{onComplete:e}=this.options;e&&e()}cancel(){this.cancelTime!==null&&this.tick(this.cancelTime),this.teardown(),this.updateFinishedPromise()}teardown(){this.state="idle",this.stopDriver(),this.resolveFinishedPromise(),this.updateFinishedPromise(),this.startTime=this.cancelTime=null,this.resolver.cancel()}stopDriver(){this.driver&&(this.driver.stop(),this.driver=void 0)}sample(e){return this.startTime=0,this.tick(e,!0)}}export{se as MainThreadAnimation};
