import{orient2d as j}from"../robust-predicates/esm/orient2d-B1zR0I1B.js";const Y=Math.pow(2,-52),q=new Uint32Array(512);class C{static from(t,n=Q,l=V){const r=t.length,h=new Float64Array(r*2);for(let i=0;i<r;i++){const o=t[i];h[2*i]=n(o),h[2*i+1]=l(o)}return new C(h)}constructor(t){const n=t.length>>1;if(n>0&&typeof t[0]!="number")throw new Error("Expected coords to contain numbers.");this.coords=t;const l=Math.max(2*n-5,0);this._triangles=new Uint32Array(l*3),this._halfedges=new Int32Array(l*3),this._hashSize=Math.ceil(Math.sqrt(n)),this._hullPrev=new Uint32Array(n),this._hullNext=new Uint32Array(n),this._hullTri=new Uint32Array(n),this._hullHash=new Int32Array(this._hashSize),this._ids=new Uint32Array(n),this._dists=new Float64Array(n),this.update()}update(){const{coords:t,_hullPrev:n,_hullNext:l,_hullTri:r,_hullHash:h}=this,i=t.length>>1;let o=1/0,f=1/0,g=-1/0,m=-1/0;for(let s=0;s<i;s++){const u=t[2*s],a=t[2*s+1];u<o&&(o=u),a<f&&(f=a),u>g&&(g=u),a>m&&(m=a),this._ids[s]=s}const d=(o+g)/2,b=(f+m)/2;let c,y,w;for(let s=0,u=1/0;s<i;s++){const a=X(d,b,t[2*s],t[2*s+1]);a<u&&(c=s,u=a)}const T=t[2*c],U=t[2*c+1];for(let s=0,u=1/0;s<i;s++){if(s===c)continue;const a=X(T,U,t[2*s],t[2*s+1]);a<u&&a>0&&(y=s,u=a)}let M=t[2*y],k=t[2*y+1],G=1/0;for(let s=0;s<i;s++){if(s===c||s===y)continue;const u=B(T,U,M,k,t[2*s],t[2*s+1]);u<G&&(w=s,G=u)}let D=t[2*w],E=t[2*w+1];if(G===1/0){for(let a=0;a<i;a++)this._dists[a]=t[2*a]-t[0]||t[2*a+1]-t[1];L(this._ids,this._dists,0,i-1);const s=new Uint32Array(i);let u=0;for(let a=0,x=-1/0;a<i;a++){const A=this._ids[a],S=this._dists[A];S>x&&(s[u++]=A,x=S)}this.hull=s.subarray(0,u),this.triangles=new Uint32Array(0),this.halfedges=new Uint32Array(0);return}if(j(T,U,M,k,D,E)<0){const s=y,u=M,a=k;y=w,M=D,k=E,w=s,D=u,E=a}const N=J(T,U,M,k,D,E);this._cx=N.x,this._cy=N.y;for(let s=0;s<i;s++)this._dists[s]=X(t[2*s],t[2*s+1],N.x,N.y);L(this._ids,this._dists,0,i-1),this._hullStart=c;let P=3;l[c]=n[w]=y,l[y]=n[c]=w,l[w]=n[y]=c,r[c]=0,r[y]=1,r[w]=2,h.fill(-1),h[this._hashKey(T,U)]=c,h[this._hashKey(M,k)]=y,h[this._hashKey(D,E)]=w,this.trianglesLen=0,this._addTriangle(c,y,w,-1,-1,-1);for(let s=0,u,a;s<this._ids.length;s++){const x=this._ids[s],A=t[2*x],S=t[2*x+1];if(s>0&&Math.abs(A-u)<=Y&&Math.abs(S-a)<=Y||(u=A,a=S,x===c||x===y||x===w))continue;let z=0;for(let H=0,F=this._hashKey(A,S);H<this._hashSize&&(z=h[(F+H)%this._hashSize],!(z!==-1&&z!==l[z]));H++);z=n[z];let _=z,p;for(;p=l[_],j(A,S,t[2*_],t[2*_+1],t[2*p],t[2*p+1])>=0;)if(_=p,_===z){_=-1;break}if(_===-1)continue;let K=this._addTriangle(_,x,l[_],-1,-1,r[_]);r[x]=this._legalize(K+2),r[_]=K,P++;let I=l[_];for(;p=l[I],j(A,S,t[2*I],t[2*I+1],t[2*p],t[2*p+1])<0;)K=this._addTriangle(I,x,p,r[x],-1,r[I]),r[x]=this._legalize(K+2),l[I]=I,P--,I=p;if(_===z)for(;p=n[_],j(A,S,t[2*p],t[2*p+1],t[2*_],t[2*_+1])<0;)K=this._addTriangle(p,x,_,-1,r[_],r[p]),this._legalize(K+2),r[p]=K,l[_]=_,P--,_=p;this._hullStart=n[x]=_,l[_]=n[I]=x,l[x]=I,h[this._hashKey(A,S)]=x,h[this._hashKey(t[2*_],t[2*_+1])]=_}this.hull=new Uint32Array(P);for(let s=0,u=this._hullStart;s<P;s++)this.hull[s]=u,u=l[u];this.triangles=this._triangles.subarray(0,this.trianglesLen),this.halfedges=this._halfedges.subarray(0,this.trianglesLen)}_hashKey(t,n){return Math.floor(O(t-this._cx,n-this._cy)*this._hashSize)%this._hashSize}_legalize(t){const{_triangles:n,_halfedges:l,coords:r}=this;let h=0,i=0;for(;;){const o=l[t],f=t-t%3;if(i=f+(t+2)%3,o===-1){if(h===0)break;t=q[--h];continue}const g=o-o%3,m=f+(t+1)%3,d=g+(o+2)%3,b=n[i],c=n[t],y=n[m],w=n[d];if(R(r[2*b],r[2*b+1],r[2*c],r[2*c+1],r[2*y],r[2*y+1],r[2*w],r[2*w+1])){n[t]=w,n[o]=b;const U=l[d];if(U===-1){let k=this._hullStart;do{if(this._hullTri[k]===d){this._hullTri[k]=t;break}k=this._hullPrev[k]}while(k!==this._hullStart)}this._link(t,U),this._link(o,l[i]),this._link(i,d);const M=g+(o+1)%3;h<q.length&&(q[h++]=M)}else{if(h===0)break;t=q[--h]}}return i}_link(t,n){this._halfedges[t]=n,n!==-1&&(this._halfedges[n]=t)}_addTriangle(t,n,l,r,h,i){const o=this.trianglesLen;return this._triangles[o]=t,this._triangles[o+1]=n,this._triangles[o+2]=l,this._link(o,r),this._link(o+1,h),this._link(o+2,i),this.trianglesLen+=3,o}}function O(e,t){const n=e/(Math.abs(e)+Math.abs(t));return(t>0?3-n:1+n)/4}function X(e,t,n,l){const r=e-n,h=t-l;return r*r+h*h}function R(e,t,n,l,r,h,i,o){const f=e-i,g=t-o,m=n-i,d=l-o,b=r-i,c=h-o,y=f*f+g*g,w=m*m+d*d,T=b*b+c*c;return f*(d*T-w*c)-g*(m*T-w*b)+y*(m*c-d*b)<0}function B(e,t,n,l,r,h){const i=n-e,o=l-t,f=r-e,g=h-t,m=i*i+o*o,d=f*f+g*g,b=.5/(i*g-o*f),c=(g*m-o*d)*b,y=(i*d-f*m)*b;return c*c+y*y}function J(e,t,n,l,r,h){const i=n-e,o=l-t,f=r-e,g=h-t,m=i*i+o*o,d=f*f+g*g,b=.5/(i*g-o*f),c=e+(g*m-o*d)*b,y=t+(i*d-f*m)*b;return{x:c,y}}function L(e,t,n,l){if(l-n<=20)for(let r=n+1;r<=l;r++){const h=e[r],i=t[h];let o=r-1;for(;o>=n&&t[e[o]]>i;)e[o+1]=e[o--];e[o+1]=h}else{const r=n+l>>1;let h=n+1,i=l;v(e,r,h),t[e[n]]>t[e[l]]&&v(e,n,l),t[e[h]]>t[e[l]]&&v(e,h,l),t[e[n]]>t[e[h]]&&v(e,n,h);const o=e[h],f=t[o];for(;;){do h++;while(t[e[h]]<f);do i--;while(t[e[i]]>f);if(i<h)break;v(e,h,i)}e[n+1]=e[i],e[i]=o,l-h+1>=i-n?(L(e,t,h,l),L(e,t,n,i-1)):(L(e,t,n,i-1),L(e,t,h,l))}}function v(e,t,n){const l=e[t];e[t]=e[n],e[n]=l}function Q(e){return e[0]}function V(e){return e[1]}export{C as default};
