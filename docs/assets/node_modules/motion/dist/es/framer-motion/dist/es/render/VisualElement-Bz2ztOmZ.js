import{time as g}from"../frameloop/sync-time-DIkHWTW-.js";import{featureDefinitions as d}from"../motion/features/definitions-YvlcAcQG.js";import{createBox as S}from"../projection/geometry/models-CJd-S-Mu.js";import{isNumericalString as M}from"../utils/is-numerical-string-B3iJ43ZS.js";import{isZeroValueString as C}from"../utils/is-zero-value-string-Cpy9U0h_.js";import{initPrefersReducedMotion as b}from"../utils/reduced-motion/index-HovULqh7.js";import{hasReducedMotionListener as T,prefersReducedMotion as P}from"../utils/reduced-motion/state-_j_n8ErL.js";import{SubscriptionManager as w}from"../utils/subscription-manager-DjabnrHi.js";import{motionValue as F}from"../value/index-B8Z5oJGu.js";import{complex as B}from"../value/types/complex/index-DEHjPLht.js";import{isMotionValue as h}from"../value/utils/is-motion-value-BbIbbK3h.js";import{getAnimatableNone as R}from"./dom/value-types/animatable-none-BuLTzw77.js";import{findValueType as N}from"./dom/value-types/find-DyLaI2IN.js";import{transformProps as x}from"./html/utils/keys-transform-BxxohAp6.js";import{visualElementStore as A}from"./store-GtpV77L3.js";import{isControllingVariants as E,isVariantNode as U}from"./utils/is-controlling-variants-DhGmwoxA.js";import{KeyframeResolver as j}from"./utils/KeyframesResolver-DKGlpZg4.js";import{updateMotionValuesFromProps as I}from"./utils/motion-values-B1cJbhy3.js";import{resolveVariantFromProps as y}from"./utils/resolve-variants-ByUSK-_G.js";import{frame as f,cancelFrame as c}from"../frameloop/frame-DhSIuZ3-.js";const m=["AnimationStart","AnimationComplete","Update","BeforeLayoutMeasure","LayoutMeasure","LayoutAnimationStart","LayoutAnimationComplete"];class nt{scrapeMotionValuesFromProps(t,e,s){return{}}constructor({parent:t,props:e,presenceContext:s,reducedMotionConfig:i,blockInitialAnimation:r,visualState:n},u={}){this.current=null,this.children=new Set,this.isVariantNode=!1,this.isControllingVariants=!1,this.shouldReduceMotion=null,this.values=new Map,this.KeyframeResolver=j,this.features={},this.valueSubscriptions=new Map,this.prevMotionValues={},this.events={},this.propEventSubscriptions={},this.notifyUpdate=()=>this.notify("Update",this.latestValues),this.render=()=>{this.current&&(this.triggerBuild(),this.renderInstance(this.current,this.renderState,this.props.style,this.projection))},this.renderScheduledAt=0,this.scheduleRender=()=>{const o=g.now();this.renderScheduledAt<o&&(this.renderScheduledAt=o,f.render(this.render,!1,!0))};const{latestValues:a,renderState:V,onUpdate:v}=n;this.onUpdate=v,this.latestValues=a,this.baseTarget={...a},this.initialValues=e.initial?{...a}:{},this.renderState=V,this.parent=t,this.props=e,this.presenceContext=s,this.depth=t?t.depth+1:0,this.reducedMotionConfig=i,this.options=u,this.blockInitialAnimation=!!r,this.isControllingVariants=E(e),this.isVariantNode=U(e),this.isVariantNode&&(this.variantChildren=new Set),this.manuallyAnimateOnMount=!!(t&&t.current);const{willChange:_,...l}=this.scrapeMotionValuesFromProps(e,{},this);for(const o in l){const p=l[o];a[o]!==void 0&&h(p)&&p.set(a[o],!1)}}mount(t){this.current=t,A.set(t,this),this.projection&&!this.projection.instance&&this.projection.mount(t),this.parent&&this.isVariantNode&&!this.isControllingVariants&&(this.removeFromVariantTree=this.parent.addVariantChild(this)),this.values.forEach((e,s)=>this.bindToMotionValue(s,e)),T.current||b(),this.shouldReduceMotion=this.reducedMotionConfig==="never"?!1:this.reducedMotionConfig==="always"?!0:P.current,this.parent&&this.parent.children.add(this),this.update(this.props,this.presenceContext)}unmount(){this.projection&&this.projection.unmount(),c(this.notifyUpdate),c(this.render),this.valueSubscriptions.forEach(t=>t()),this.valueSubscriptions.clear(),this.removeFromVariantTree&&this.removeFromVariantTree(),this.parent&&this.parent.children.delete(this);for(const t in this.events)this.events[t].clear();for(const t in this.features){const e=this.features[t];e&&(e.unmount(),e.isMounted=!1)}this.current=null}bindToMotionValue(t,e){this.valueSubscriptions.has(t)&&this.valueSubscriptions.get(t)();const s=x.has(t);s&&this.onBindTransform&&this.onBindTransform();const i=e.on("change",u=>{this.latestValues[t]=u,this.props.onUpdate&&f.preRender(this.notifyUpdate),s&&this.projection&&(this.projection.isTransformDirty=!0)}),r=e.on("renderRequest",this.scheduleRender);let n;window.MotionCheckAppearSync&&(n=window.MotionCheckAppearSync(this,t,e)),this.valueSubscriptions.set(t,()=>{i(),r(),n&&n(),e.owner&&e.stop()})}sortNodePosition(t){return!this.current||!this.sortInstanceNodePosition||this.type!==t.type?0:this.sortInstanceNodePosition(this.current,t.current)}updateFeatures(){let t="animation";for(t in d){const e=d[t];if(!e)continue;const{isEnabled:s,Feature:i}=e;if(!this.features[t]&&i&&s(this.props)&&(this.features[t]=new i(this)),this.features[t]){const r=this.features[t];r.isMounted?r.update():(r.mount(),r.isMounted=!0)}}}triggerBuild(){this.build(this.renderState,this.latestValues,this.props)}measureViewportBox(){return this.current?this.measureInstanceViewportBox(this.current,this.props):S()}getStaticValue(t){return this.latestValues[t]}setStaticValue(t,e){this.latestValues[t]=e}update(t,e){(t.transformTemplate||this.props.transformTemplate)&&this.scheduleRender(),this.prevProps=this.props,this.props=t,this.prevPresenceContext=this.presenceContext,this.presenceContext=e;for(let s=0;s<m.length;s++){const i=m[s];this.propEventSubscriptions[i]&&(this.propEventSubscriptions[i](),delete this.propEventSubscriptions[i]);const r="on"+i,n=t[r];n&&(this.propEventSubscriptions[i]=this.on(i,n))}this.prevMotionValues=I(this,this.scrapeMotionValuesFromProps(t,this.prevProps,this),this.prevMotionValues),this.handleChildMotionValue&&this.handleChildMotionValue(),this.onUpdate&&this.onUpdate(this)}getProps(){return this.props}getVariant(t){return this.props.variants?this.props.variants[t]:void 0}getDefaultTransition(){return this.props.transition}getTransformPagePoint(){return this.props.transformPagePoint}getClosestVariantNode(){return this.isVariantNode?this:this.parent?this.parent.getClosestVariantNode():void 0}addVariantChild(t){const e=this.getClosestVariantNode();if(e)return e.variantChildren&&e.variantChildren.add(t),()=>e.variantChildren.delete(t)}addValue(t,e){const s=this.values.get(t);e!==s&&(s&&this.removeValue(t),this.bindToMotionValue(t,e),this.values.set(t,e),this.latestValues[t]=e.get())}removeValue(t){this.values.delete(t);const e=this.valueSubscriptions.get(t);e&&(e(),this.valueSubscriptions.delete(t)),delete this.latestValues[t],this.removeValueFromRenderState(t,this.renderState)}hasValue(t){return this.values.has(t)}getValue(t,e){if(this.props.values&&this.props.values[t])return this.props.values[t];let s=this.values.get(t);return s===void 0&&e!==void 0&&(s=F(e===null?void 0:e,{owner:this}),this.addValue(t,s)),s}readValue(t,e){var s;let i=this.latestValues[t]!==void 0||!this.current?this.latestValues[t]:(s=this.getBaseTargetFromProps(this.props,t))!==null&&s!==void 0?s:this.readValueFromInstance(this.current,t,this.options);return i!=null&&(typeof i=="string"&&(M(i)||C(i))?i=parseFloat(i):!N(i)&&B.test(e)&&(i=R(t,e)),this.setBaseTarget(t,h(i)?i.get():i)),h(i)?i.get():i}setBaseTarget(t,e){this.baseTarget[t]=e}getBaseTarget(t){var e;const{initial:s}=this.props;let i;if(typeof s=="string"||typeof s=="object"){const n=y(this.props,s,(e=this.presenceContext)===null||e===void 0?void 0:e.custom);n&&(i=n[t])}if(s&&i!==void 0)return i;const r=this.getBaseTargetFromProps(this.props,t);return r!==void 0&&!h(r)?r:this.initialValues[t]!==void 0&&i===void 0?void 0:this.baseTarget[t]}on(t,e){return this.events[t]||(this.events[t]=new w),this.events[t].add(e)}notify(t,...e){this.events[t]&&this.events[t].notify(...e)}}export{nt as VisualElement};
