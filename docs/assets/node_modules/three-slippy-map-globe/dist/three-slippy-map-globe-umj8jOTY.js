import"../../three/build/three.module-DDr6UARD.js";import{Camera as Ie,Vector3 as te,Group as Te,Mesh as le,SphereGeometry as ue,MeshBasicMaterial as je,Frustum as Le,Matrix4 as Ae,MeshLambertMaterial as xe,TextureLoader as Ce,SRGBColorSpace as Ue}from"../../three/build/three.core-BhFki44V.js";import Re from"../../d3-octree/src/octree-BJ_qPSSy.js";import re from"../../d3-scale/src/linear-EAbKQ90K.js";import{mercatorRaw as ce}from"../../d3-geo/src/projection/mercator-H0AkuQ-X.js";function J(t,e){(e==null||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function We(t){if(Array.isArray(t))return t}function ke(t){if(Array.isArray(t))return J(t)}function W(t,e,n){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:n;throw new TypeError("Private element is not present on this object")}function ze(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function De(t,e,n){return e=G(e),qe(t,fe()?Reflect.construct(e,[],G(t).constructor):e.apply(t,n))}function se(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function Be(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){return t.get(W(t,e))}function O(t,e,n){se(t,e),e.set(t,n)}function I(t,e,n){return t.set(W(t,e),n),n}function Fe(t,e){se(t,e),e.add(t)}function Ge(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,ve(r.key),r)}}function Ve(t,e,n){return Ge(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function x(t,e,n){return(e=ve(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function G(t){return G=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},G(t)}function Ne(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Q(t,e)}function fe(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(fe=function(){return!!t})()}function He(t){if(typeof Symbol<"u"&&t[Symbol.iterator]!=null||t["@@iterator"]!=null)return Array.from(t)}function $e(t,e){var n=t==null?null:typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(n!=null){var r,c,u,l,i=[],o=!0,d=!1;try{if(u=(n=n.call(t)).next,e!==0)for(;!(o=(r=u.call(n)).done)&&(i.push(r.value),i.length!==e);o=!0);}catch(s){d=!0,c=s}finally{try{if(!o&&n.return!=null&&(l=n.return(),Object(l)!==l))return}finally{if(d)throw c}}return i}}function Ke(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Xe(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function qe(t,e){if(e&&(typeof e=="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ze(t)}function Q(t,e){return Q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,r){return n.__proto__=r,n},Q(t,e)}function F(t,e){return We(t)||$e(t,e)||pe(t,e)||Ke()}function he(t){return ke(t)||He(t)||pe(t)||Xe()}function Je(t,e){if(typeof t!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var r=n.call(t,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}function ve(t){var e=Je(t,"string");return typeof e=="symbol"?e:e+""}function pe(t,e){if(t){if(typeof t=="string")return J(t,e);var n={}.toString.call(t).slice(8,-1);return n==="Object"&&t.constructor&&(n=t.constructor.name),n==="Map"||n==="Set"?Array.from(t):n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?J(t,e):void 0}}var de=function(e){e instanceof Array?e.forEach(de):(e.map&&e.map.dispose(),e.dispose())},me=function(e){e.geometry&&e.geometry.dispose(),e.material&&de(e.material),e.texture&&e.texture.dispose(),e.children&&e.children.forEach(me)},ne=function(e){if(e&&e.children)for(;e.children.length;){var n=e.children[0];e.remove(n),me(n)}};function ye(t,e,n){var r=(90-t)*Math.PI/180,c=(90-e)*Math.PI/180;return{x:n*Math.sin(r)*Math.cos(c),y:n*Math.cos(r),z:n*Math.sin(r)*Math.sin(c)}}function Qe(t){var e=t.x,n=t.y,r=t.z,c=Math.sqrt(e*e+n*n+r*r),u=Math.acos(n/c),l=Math.atan2(r,e);return{lat:90-u*180/Math.PI,lng:90-l*180/Math.PI-(l<-Math.PI/2?360:0),r:c}}function L(t){return t*Math.PI/180}var Me=function(e){return 1-(ce(0,(.5-e)*Math.PI)[1]/Math.PI+1)/2},X=function(e){return Math.max(0,Math.min(1,Me(e)))},ae=function(e){return .5-ce.invert(0,(2*(1-e)-1)*Math.PI)[1]/Math.PI},Ze=function(e){for(var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,c=re().domain([1,0]).range([n,r]).clamp(!0),u=re().domain([X(n),X(r)]).range([1,0]).clamp(!0),l=function(b){return u(X(c(b)))},i=e.array,o=0,d=i.length;o<d;o+=2)i[o+1]=l(i[o+1]);e.needsUpdate=!0},ie=function(e,n,r,c){var u=Math.pow(2,e),l=Math.max(0,Math.min(u-1,Math.floor((r+180)*u/360))),i=(90-c)/180;n&&(i=Math.max(0,Math.min(1,Me(i))));var o=Math.floor(i*u);return[l,o]},Z=function(e,n){for(var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,c=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,u=arguments.length>4?arguments[4]:void 0,l=arguments.length>5?arguments[5]:void 0,i=[],o=Math.pow(2,e),d=360/o,s=180/o,b=u===void 0?o-1:u,y=l===void 0?o-1:l,f=r,E=Math.min(o-1,b);f<=E;f++)for(var p=c,j=Math.min(o-1,y);p<=j;p++){var g=p,w=s;if(n){g=p===0?p:ae(p/o)*o;var v=p+1===o?p+1:ae((p+1)/o)*o;w=(v-g)*180/o}var S=-180+(f+.5)*d,M=90-(g*180/o+w/2),_=w;i.push({x:f,y:p,lng:S,lat:M,latLen:_})}return i},Ye=6,et=7,tt=3,rt=90,P=new WeakMap,T=new WeakMap,q=new WeakMap,D=new WeakMap,m=new WeakMap,V=new WeakMap,C=new WeakMap,A=new WeakMap,B=new WeakSet,ct=function(t){function e(n){var r,c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},u=c.tileUrl,l=c.minLevel,i=l===void 0?0:l,o=c.maxLevel,d=o===void 0?17:o,s=c.mercatorProjection,b=s===void 0?!0:s;return Be(this,e),r=De(this,e),Fe(r,B),O(r,P,void 0),O(r,T,void 0),O(r,q,void 0),O(r,D,void 0),O(r,m,{}),O(r,V,void 0),O(r,C,void 0),O(r,A,void 0),x(r,"minLevel",void 0),x(r,"maxLevel",void 0),x(r,"thresholds",he(new Array(30)).map(function(y,f){return 8/Math.pow(2,f)})),x(r,"curvatureResolution",5),x(r,"tileMargin",0),x(r,"clearTiles",function(){Object.values(a(m,r)).forEach(function(y){y.forEach(function(f){f.obj&&(r.remove(f.obj),ne(f.obj),delete f.obj)})}),I(m,r,{})}),I(P,r,n),r.tileUrl=u,I(T,r,b),r.minLevel=i,r.maxLevel=d,r.level=0,r.add(I(A,r,new le(new ue(a(P,r)*.99,180,90),new je({color:0})))),a(A,r).visible=!1,a(A,r).material.polygonOffset=!0,a(A,r).material.polygonOffsetUnits=3,a(A,r).material.polygonOffsetFactor=1,r}return Ne(e,t),Ve(e,[{key:"tileUrl",get:function(){return a(q,this)},set:function(r){I(q,this,r),this.updatePov(a(C,this))}},{key:"level",get:function(){return a(D,this)},set:function(r){var c=this;a(m,this)[r]||W(B,this,nt).call(this,r);var u=a(D,this);if(I(D,this,r),!(r===u||u===void 0)){if(a(A,this).visible=r>0,a(m,this)[r].forEach(function(i){return i.obj&&(i.obj.material.depthWrite=!0)}),u<r&&a(m,this)[u].forEach(function(i){return i.obj&&(i.obj.material.depthWrite=!1)}),u>r)for(var l=r+1;l<=u;l++)a(m,this)[l]&&a(m,this)[l].forEach(function(i){i.obj&&(c.remove(i.obj),ne(i.obj),delete i.obj)});W(B,this,oe).call(this)}}},{key:"updatePov",value:function(r){var c=this;if(!(!r||!(r instanceof Ie))){I(C,this,r);var u;if(I(V,this,function(s){if(!s.hullPnts){var b=360/Math.pow(2,c.level),y=s.lng,f=s.lat,E=s.latLen,p=y-b/2,j=y+b/2,g=f-E/2,w=f+E/2;s.hullPnts=[[f,y],[g,p],[w,p],[g,j],[w,j]].map(function(v){var S=F(v,2),M=S[0],_=S[1];return ye(M,_,a(P,c))}).map(function(v){var S=v.x,M=v.y,_=v.z;return new te(S,M,_)})}return u||(u=new Le,r.updateMatrix(),r.updateMatrixWorld(),u.setFromProjectionMatrix(new Ae().multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse))),s.hullPnts.some(function(v){return u.containsPoint(v.clone().applyMatrix4(c.matrixWorld))})}),this.tileUrl){var l=r.position.clone(),i=l.distanceTo(this.getWorldPosition(new te)),o=(i-a(P,this))/a(P,this),d=this.thresholds.findIndex(function(s){return s&&s<=o});this.level=Math.min(this.maxLevel,Math.max(this.minLevel,d<0?this.thresholds.length:d)),W(B,this,oe).call(this)}}}}])}(Te);function nt(t){var e=this;if(t>et){a(m,this)[t]=[];return}var n=a(m,this)[t]=Z(t,a(T,this));n.forEach(function(r){return r.centroid=ye(r.lat,r.lng,a(P,e))}),n.octree=Re().x(function(r){return r.centroid.x}).y(function(r){return r.centroid.y}).z(function(r){return r.centroid.z}).addAll(n)}function oe(){var t=this;if(!(!this.tileUrl||this.level===void 0||!a(m,this).hasOwnProperty(this.level))&&!(!a(V,this)&&this.level>Ye)){var e=a(m,this)[this.level];if(a(C,this)){var n=this.worldToLocal(a(C,this).position.clone());if(e.octree){var r,c=this.worldToLocal(a(C,this).position.clone()),u=(c.length()-a(P,this))*tt;e=(r=e.octree).findAllWithinRadius.apply(r,he(c).concat([u]))}else{var l=Qe(n),i=(l.r/a(P,this)-1)*rt,o=i/Math.cos(L(l.lat)),d=[l.lng-o,l.lng+o],s=[l.lat+i,l.lat-i],b=ie(this.level,a(T,this),d[0],s[0]),y=F(b,2),f=y[0],E=y[1],p=ie(this.level,a(T,this),d[1],s[1]),j=F(p,2),g=j[0],w=j[1];!e.record&&(e.record={});var v=e.record;if(!v.hasOwnProperty("".concat(Math.round((f+g)/2),"_").concat(Math.round((E+w)/2))))e=Z(this.level,a(T,this),f,E,g,w).map(function(h){var U="".concat(h.x,"_").concat(h.y);return v.hasOwnProperty(U)?v[U]:(v[U]=h,e.push(h),h)});else{for(var S=[],M=f;M<=g;M++)for(var _=E;_<=w;_++){var k="".concat(M,"_").concat(_);v.hasOwnProperty(k)||(v[k]=Z(this.level,a(T,this),M,_,M,_)[0],e.push(v[k])),S.push(v[k])}e=S}}}e.filter(function(h){return!h.obj}).filter(a(V,this)||function(){return!0}).forEach(function(h){var U=h.x,_e=h.y,be=h.lng,N=h.lat,H=h.latLen,ge=360/Math.pow(2,t.level);if(!h.obj){var $=ge*(1-t.tileMargin),K=H*(1-t.tileMargin),we=L(be),Pe=L(-N),Y=new le(new ue(a(P,t),Math.ceil($/t.curvatureResolution),Math.ceil(K/t.curvatureResolution),L(90-$/2)+we,L($),L(90-K/2)+Pe,L(K)),new xe);if(a(T,t)){var Se=[N+H/2,N-H/2].map(function(z){return .5-z/180}),ee=F(Se,2),Ee=ee[0],Oe=ee[1];Ze(Y.geometry.attributes.uv,Ee,Oe)}h.obj=Y}h.loading||(h.loading=!0,new Ce().load(t.tileUrl(U,_e,t.level),function(z){var R=h.obj;R&&(z.colorSpace=Ue,R.material.map=z,R.material.color=null,R.material.needsUpdate=!0,t.add(R)),h.loading=!1}))})}}export{ct as default};
